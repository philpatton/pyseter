{
  "hash": "4afe3cc7ca3382752167e0a499abc8a3",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Evaluating *AnyDorsal*\njupyter:\n  kernelspec:\n    display_name: Python (Pyseter)\n    language: python\n    name: pyseter_env\nexecute:\n  cache: true\n---\n\nIn this notebook, we'll demonstrate how do evaluate *AnyDorsal*'s' performance on a test dataset. We'll use the [Happy Whale and Dolphin Kaggle competition dataset](https://www.kaggle.com/competitions/happy-whale-and-dolphin/data) as an example. You can download the data by following that linked page (click the big \"Download all\" button). FYI, you'll have to create an account first.\n\nIn the [Predicting IDs](identify.qmd) notebook, we demonstrated how to extract features for the Happywhale dataset using a set of bounding boxes. Here, we'll load the features in.\n\n::: {#3eae08c4 .cell execution_count=1}\n``` {.python .cell-code}\n%config InlineBackend.figure_format = 'retina'\n\nfrom pyseter.sort import load_features\nfrom pyseter.identify import predict_ids\nimport matplotlib.pyplot as plt\nimport pandas as pd\n\ndata_dir = '/Users/PattonP/datasets/happywhale/'\n\nfeature_dir = data_dir + '/features'\n\nreference_path = feature_dir + '/train_features.npy'\nreference_files, reference_features = load_features(reference_path)\n\nquery_path = feature_dir + '/test_features.npy'\nquery_files, query_features = load_features(query_path)\n```\n:::\n\n\nIn order to evaluate the performance of *AnyDorsal* on the test set, we'll need to know the IDs of animals in the train set and the test set. \n\n::: {#c97d8555 .cell execution_count=2}\n``` {.python .cell-code}\ndata_url = (\n    'https://raw.githubusercontent.com/philpatton/pyseter/main/' \n    'data/happywhale-ids.csv'\n)\nid_df = pd.read_csv(data_url)\n\n# excel on mac corrupts the IDs (no need to do this on PC or linux)\nid_df['individual_id'] = id_df['individual_id'].apply(\n    lambda x: str(int(float(x))) if 'E+' in str(x) else x\n)\n\nid_df.head(10)\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>image</th>\n      <th>species</th>\n      <th>individual_id</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>000110707af0ba.jpg</td>\n      <td>gray_whale</td>\n      <td>fbe2b15b5481</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>00021adfb725ed.jpg</td>\n      <td>melon_headed_whale</td>\n      <td>cadddb1636b9</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>000562241d384d.jpg</td>\n      <td>humpback_whale</td>\n      <td>1a71fbb72250</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0006287ec424cb.jpg</td>\n      <td>false_killer_whale</td>\n      <td>1424c7fec826</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0007c33415ce37.jpg</td>\n      <td>false_killer_whale</td>\n      <td>60008f293a2b</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>0007d9bca26a99.jpg</td>\n      <td>bottlenose_dolphin</td>\n      <td>4b00fe572063</td>\n    </tr>\n    <tr>\n      <th>6</th>\n      <td>000809ecb2ccad.jpg</td>\n      <td>beluga</td>\n      <td>1ce3ba6a3c29</td>\n    </tr>\n    <tr>\n      <th>7</th>\n      <td>00087baf5cef7a.jpg</td>\n      <td>humpback_whale</td>\n      <td>8e5253662392</td>\n    </tr>\n    <tr>\n      <th>8</th>\n      <td>00098d1376dab2.jpg</td>\n      <td>humpback_whale</td>\n      <td>c4274d90be60</td>\n    </tr>\n    <tr>\n      <th>9</th>\n      <td>000a8f2d5c316a.jpg</td>\n      <td>bottlenose_dolphin</td>\n      <td>b9907151f66e</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nNow we'll predict the IDs in the query set. \n\n::: {#6650c464 .cell execution_count=3}\n``` {.python .cell-code}\nquery_dict = dict(zip(query_files, query_features))\nreference_dict = dict(zip(reference_files, reference_features))\n\nprediction_df = predict_ids(reference_dict, query_dict, id_df, proposed_id_count=5)\nprediction_df.head(20)\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>image</th>\n      <th>rank</th>\n      <th>predicted_id</th>\n      <th>score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>a704da09e32dc3.jpg</td>\n      <td>1</td>\n      <td>5f2296c18e26</td>\n      <td>0.500233</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>a704da09e32dc3.jpg</td>\n      <td>2</td>\n      <td>new_individual</td>\n      <td>0.500000</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>a704da09e32dc3.jpg</td>\n      <td>3</td>\n      <td>61f9e4cd30eb</td>\n      <td>0.432061</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>a704da09e32dc3.jpg</td>\n      <td>4</td>\n      <td>cb372e9b2c48</td>\n      <td>0.411830</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>a704da09e32dc3.jpg</td>\n      <td>5</td>\n      <td>43dad7ffa3c7</td>\n      <td>0.405389</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>de1569496d42f4.jpg</td>\n      <td>1</td>\n      <td>ed237f7c2165</td>\n      <td>0.826259</td>\n    </tr>\n    <tr>\n      <th>6</th>\n      <td>de1569496d42f4.jpg</td>\n      <td>2</td>\n      <td>new_individual</td>\n      <td>0.500000</td>\n    </tr>\n    <tr>\n      <th>7</th>\n      <td>de1569496d42f4.jpg</td>\n      <td>3</td>\n      <td>8c4a71fd3eb1</td>\n      <td>0.446297</td>\n    </tr>\n    <tr>\n      <th>8</th>\n      <td>de1569496d42f4.jpg</td>\n      <td>4</td>\n      <td>7d4deec3b721</td>\n      <td>0.424570</td>\n    </tr>\n    <tr>\n      <th>9</th>\n      <td>de1569496d42f4.jpg</td>\n      <td>5</td>\n      <td>fcc7ade0c50a</td>\n      <td>0.376511</td>\n    </tr>\n    <tr>\n      <th>10</th>\n      <td>4ab51dd663dd29.jpg</td>\n      <td>1</td>\n      <td>b9b24be2d5ae</td>\n      <td>0.680653</td>\n    </tr>\n    <tr>\n      <th>11</th>\n      <td>4ab51dd663dd29.jpg</td>\n      <td>2</td>\n      <td>31f748b822f4</td>\n      <td>0.503390</td>\n    </tr>\n    <tr>\n      <th>12</th>\n      <td>4ab51dd663dd29.jpg</td>\n      <td>3</td>\n      <td>new_individual</td>\n      <td>0.500000</td>\n    </tr>\n    <tr>\n      <th>13</th>\n      <td>4ab51dd663dd29.jpg</td>\n      <td>4</td>\n      <td>7845337998d6</td>\n      <td>0.497671</td>\n    </tr>\n    <tr>\n      <th>14</th>\n      <td>4ab51dd663dd29.jpg</td>\n      <td>5</td>\n      <td>efda8f368763</td>\n      <td>0.455688</td>\n    </tr>\n    <tr>\n      <th>15</th>\n      <td>da27c3f9f96504.jpg</td>\n      <td>1</td>\n      <td>c02b7ad6faa0</td>\n      <td>0.937102</td>\n    </tr>\n    <tr>\n      <th>16</th>\n      <td>da27c3f9f96504.jpg</td>\n      <td>2</td>\n      <td>new_individual</td>\n      <td>0.500000</td>\n    </tr>\n    <tr>\n      <th>17</th>\n      <td>da27c3f9f96504.jpg</td>\n      <td>3</td>\n      <td>70858f1edf62</td>\n      <td>0.375488</td>\n    </tr>\n    <tr>\n      <th>18</th>\n      <td>da27c3f9f96504.jpg</td>\n      <td>4</td>\n      <td>72b0033dd4fd</td>\n      <td>0.367204</td>\n    </tr>\n    <tr>\n      <th>19</th>\n      <td>da27c3f9f96504.jpg</td>\n      <td>5</td>\n      <td>749e56a8ec71</td>\n      <td>0.354002</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Mean average precision\n\nWe are going to evaluate *AnyDorsal* with Mean Average Precision (MAP). MAP evaluates a set of predictions, in this case, a set of 5 predictions. For a set of five ordered predictions, the precision score will be $1/1 = 1$ if the first prediction is correct, $1/2$ if the second is correct, and so on until $1/5$ if the fifth prediction is correct, or $0$ if none of the five predictions are correct. MAP is the mean precision score for a set.\n\nSo we need to get the `rank` of the correct ID for every image in the test set. One way to do so is to merge the ID DataFrame with the prediction DataFrame. We only want one row per test image, so we need to merge on both the image and ID columns. We can check to see that it worked by checking the number of rows in the result (there are `27956` images in the testing dataset).\n\n::: {#9c1f60fb .cell execution_count=4}\n``` {.python .cell-code}\n# add the predictions and the scores to the id dataframe\nperformance_df = id_df.merge(\n    prediction_df,\n    how='left',\n    left_on=['image', 'individual_id'],\n    right_on=['image', 'predicted_id']\n)\n\n# filter out the training images\ntrain_images = pd.read_csv(data_dir + '/train.csv').image\nperformance_df = performance_df.loc[~performance_df.image.isin(train_images)]\nprint(performance_df.shape)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(27956, 6)\n```\n:::\n:::\n\n\n::: {#135a66af .cell execution_count=5}\n``` {.python .cell-code}\nperformance_df.head(20)\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>image</th>\n      <th>species</th>\n      <th>individual_id</th>\n      <th>rank</th>\n      <th>predicted_id</th>\n      <th>score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>000110707af0ba.jpg</td>\n      <td>gray_whale</td>\n      <td>fbe2b15b5481</td>\n      <td>1.0</td>\n      <td>fbe2b15b5481</td>\n      <td>0.871143</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0006287ec424cb.jpg</td>\n      <td>false_killer_whale</td>\n      <td>1424c7fec826</td>\n      <td>1.0</td>\n      <td>1424c7fec826</td>\n      <td>0.794225</td>\n    </tr>\n    <tr>\n      <th>6</th>\n      <td>000809ecb2ccad.jpg</td>\n      <td>beluga</td>\n      <td>1ce3ba6a3c29</td>\n      <td>1.0</td>\n      <td>1ce3ba6a3c29</td>\n      <td>0.797251</td>\n    </tr>\n    <tr>\n      <th>8</th>\n      <td>00098d1376dab2.jpg</td>\n      <td>humpback_whale</td>\n      <td>c4274d90be60</td>\n      <td>1.0</td>\n      <td>c4274d90be60</td>\n      <td>0.816240</td>\n    </tr>\n    <tr>\n      <th>10</th>\n      <td>000b8d89c738bd.jpg</td>\n      <td>dusky_dolphin</td>\n      <td>new_individual</td>\n      <td>1.0</td>\n      <td>new_individual</td>\n      <td>0.500000</td>\n    </tr>\n    <tr>\n      <th>15</th>\n      <td>000e246888710c.jpg</td>\n      <td>melon_headed_whale</td>\n      <td>new_individual</td>\n      <td>2.0</td>\n      <td>new_individual</td>\n      <td>0.500000</td>\n    </tr>\n    <tr>\n      <th>16</th>\n      <td>000eb6e73a31a5.jpg</td>\n      <td>bottlenose_dolphin</td>\n      <td>77410a623426</td>\n      <td>1.0</td>\n      <td>77410a623426</td>\n      <td>0.709175</td>\n    </tr>\n    <tr>\n      <th>17</th>\n      <td>000fe6ebfc9893.jpg</td>\n      <td>spinner_dolphin</td>\n      <td>8805324885f2</td>\n      <td>1.0</td>\n      <td>8805324885f2</td>\n      <td>0.942707</td>\n    </tr>\n    <tr>\n      <th>20</th>\n      <td>0011f7a65044e4.jpg</td>\n      <td>spinner_dolphin</td>\n      <td>d5dcbb35777c</td>\n      <td>1.0</td>\n      <td>d5dcbb35777c</td>\n      <td>0.676094</td>\n    </tr>\n    <tr>\n      <th>21</th>\n      <td>0012ff300032e3.jpg</td>\n      <td>beluga</td>\n      <td>19b638e11443</td>\n      <td>1.0</td>\n      <td>19b638e11443</td>\n      <td>0.950292</td>\n    </tr>\n    <tr>\n      <th>23</th>\n      <td>00150406ce5395.jpg</td>\n      <td>false_killer_whale</td>\n      <td>2280b5fcc6c2</td>\n      <td>1.0</td>\n      <td>2280b5fcc6c2</td>\n      <td>0.837772</td>\n    </tr>\n    <tr>\n      <th>25</th>\n      <td>0016cd18d6410e.jpg</td>\n      <td>cuviers_beaked_whale</td>\n      <td>65620eadc0b4</td>\n      <td>1.0</td>\n      <td>65620eadc0b4</td>\n      <td>0.582929</td>\n    </tr>\n    <tr>\n      <th>27</th>\n      <td>0017a9c11c61a8.jpg</td>\n      <td>beluga</td>\n      <td>new_individual</td>\n      <td>2.0</td>\n      <td>new_individual</td>\n      <td>0.500000</td>\n    </tr>\n    <tr>\n      <th>29</th>\n      <td>0017f7e0de07b1.jpg</td>\n      <td>bottlenose_dolphin</td>\n      <td>81bec36eb86e</td>\n      <td>1.0</td>\n      <td>81bec36eb86e</td>\n      <td>0.840179</td>\n    </tr>\n    <tr>\n      <th>32</th>\n      <td>001c4c6d532419.jpg</td>\n      <td>bottlenose_dolphin</td>\n      <td>2efee119d786</td>\n      <td>1.0</td>\n      <td>2efee119d786</td>\n      <td>0.748652</td>\n    </tr>\n    <tr>\n      <th>34</th>\n      <td>001dc45839b1b5.jpg</td>\n      <td>southern_right_whale</td>\n      <td>cd2e1d83c6a1</td>\n      <td>1.0</td>\n      <td>cd2e1d83c6a1</td>\n      <td>0.791898</td>\n    </tr>\n    <tr>\n      <th>35</th>\n      <td>001ea84d905ced.jpg</td>\n      <td>humpback_whale</td>\n      <td>02f5c5ee9c2a</td>\n      <td>1.0</td>\n      <td>02f5c5ee9c2a</td>\n      <td>0.680320</td>\n    </tr>\n    <tr>\n      <th>43</th>\n      <td>00248b9385e2e0.jpg</td>\n      <td>blue_whale</td>\n      <td>67b7b6934db9</td>\n      <td>1.0</td>\n      <td>67b7b6934db9</td>\n      <td>0.509903</td>\n    </tr>\n    <tr>\n      <th>48</th>\n      <td>002c7034834e2c.jpg</td>\n      <td>killer_whale</td>\n      <td>ed15fd01efbe</td>\n      <td>1.0</td>\n      <td>ed15fd01efbe</td>\n      <td>0.815825</td>\n    </tr>\n    <tr>\n      <th>49</th>\n      <td>002d7a5f6d6765.jpg</td>\n      <td>beluga</td>\n      <td>3a055fad1478</td>\n      <td>NaN</td>\n      <td>NaN</td>\n      <td>NaN</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nAny image with an `NA` rank means that the true ID was not one of the `proposed_ids`. \n\nWe can compute the precision by taking the reciprocal of the rank. After we do that, we'll fill the NA values with zero, since none of the five predictions were correct.\n\n::: {#b31f32eb .cell execution_count=6}\n``` {.python .cell-code}\nperformance_df['precision'] = 1 / performance_df['rank'] \nperformance_df['precision'] = performance_df['precision'].fillna(0)\nmap5 = performance_df.precision.mean()\nprint(f'MAP@5: {map5:0.3f}')\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMAP@5: 0.863\n```\n:::\n:::\n\n\nFor fun, we can look at the results by species\n\n::: {#1bcadff0 .cell execution_count=7}\n``` {.python .cell-code}\nimport matplotlib.pyplot as plt\n\nplt.style.use('fivethirtyeight')\nplt.rcParams['axes.facecolor'] = 'white'\nplt.rcParams['figure.facecolor'] = 'white'\n\nmap_df = (\n    performance_df.groupby('species')\n        .precision\n        .mean()\n        .rename('MAP')\n        .reset_index()\n        .sort_values('MAP')\n)\n\nfig, ax = plt.subplots(figsize=(4, 8))\nax.scatter(map_df.MAP, map_df.species)\nfor row in map_df.itertuples():\n    ax.text(row.MAP - 0.02, row.species, f'{row.MAP:0.2f}', ha='right', \n            va='center', fontsize=12)\nax.set_xlim((0,1.01))\nax.set_title('AnyDorsal Performance')\nax.set_xlabel('Mean average precision')\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](evaluate_files/figure-html/cell-8-output-1.png){width=622 height=720}\n:::\n:::\n\n\n",
    "supporting": [
      "evaluate_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}